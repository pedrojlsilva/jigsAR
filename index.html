<html>

<head>
  <title>Augmented Reality Marker Detector</title>

  <script type="text/javascript" src="libs/polyfill.js"></script> 
  
  <script type="text/javascript" src="cv.js"></script> 
  <script type="text/javascript" src="aruco.js"></script> 
  <script type="text/javascript" src="perspective-transform.js"></script>

  <script>
    var arucoCoords = [1308, 184, 1698, 182, 1701, 577, 1307, 575];
    var pieceCoords = [1307, 610, 1701, 610, 1701, 1004, 1304, 1004];
    var puzzleCoords = [95, 62, 1271, 65, 1271, 1004, 92, 1005];

    var newPieceCoords = [0, 0, 0, 0, 0, 0, 0, 0];
    var newPuzzleCoords = [0, 0, 0, 0, 0, 0, 0, 0];

    var srcCorners = [0, 1, 0, 0, 1, 0, 1, 1];
    var dstCorners = [564, 1468, 564, 1092, 939, 1092, 939, 1468];

    var video, canvas, context, context2, imageData, detector;

    var histograms = new Array(20 * 64); // using 64 bins per color histogram

    var H2;

    var tempHist = new Array(64);
    for(var i = 0; i < 64; i++) {
      tempHist[i] = i;
    }

    var sampleHist = [0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 35, 67, 243,
                      13, 212, 79, 132, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 16, 201,
                      5, 261, 470, 472, 0, 296, 83, 109,
                      0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 3, 30, 0, 0, 17, 7256];

    var basehist = [[857, 63, 24, 0, 0, 15, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 815, 37, 19, 0, 74, 245, 213, 58, 0, 0, 41, 103, 0, 0, 0, 64, 68, 0, 0, 0, 554, 47, 9, 1, 0, 29, 338, 35, 0, 0, 6, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 125, 23, 0, 0, 0, 14, 6065],
    [1444, 44, 43, 0, 2, 52, 154, 0, 0, 1, 389, 754, 0, 0, 0, 0, 53, 0, 0, 0, 13, 210, 120, 0, 0, 25, 206, 276, 0, 0, 0, 0, 0, 0, 0, 0, 4, 12, 1, 0, 2, 87, 261, 45, 0, 0, 0, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 0, 0, 0, 2, 5754],
    [815, 76, 92, 0, 0, 12, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71, 5, 75, 0, 133, 138, 147, 75, 0, 0, 12, 8, 0, 0, 0, 0, 0, 0, 0, 0, 355, 114, 1, 11, 107, 625, 247, 47, 0, 0, 0, 31, 0, 0, 0, 0, 0, 0, 0, 0, 0, 194, 17, 1, 0, 3, 12, 6573],
    [1268, 75, 1, 0, 138, 126, 20, 0, 0, 0, 26, 279, 0, 0, 0, 0, 18, 2, 0, 0, 46, 342, 95, 0, 0, 3, 161, 429, 0, 0, 0, 11, 0, 0, 0, 0, 21, 22, 4, 0, 14, 73, 437, 141, 0, 0, 2, 157, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20, 11, 1, 0, 0, 8, 6049],
    [896, 19, 0, 0, 296, 13, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 69, 2, 0, 0, 466, 338, 26, 0, 1, 11, 46, 6, 0, 0, 0, 0, 0, 0, 0, 0, 14, 37, 0, 0, 0, 54, 805, 35, 0, 0, 1, 36, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 185, 2, 0, 0, 15, 6626]];

    var normalizedhist = [[0.13632269042137923, 0.010509458512661395, 0.02542288059253328, 0, 0.00010009008107296567, 0.0029026123511160045, 0.011210089080172155, 0, 0, 0.00010009008107296567, 0.022320088079271345, 0, 0, 0, 0, 0, 0.14182764488039235, 0.001801621459313382, 0.00010009008107296567, 0, 0.00740666599939946, 0.019517565809228307, 0.0035031528375537983, 0, 0, 0.0008007206485837253, 0.005705134621159043, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.017015313782404163, 0.0019017115403863478, 0.0004003603242918627, 0, 0, 0.0008007206485837253, 0.5800220198178361, 0.008407566810129117, 0, 0, 0, 0.0008007206485837253, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00010009008107296567, 0.0010009008107296567, 0, 0, 0, 9],

      [0.15321601941747573, 0.006775889967637541, 0.00849514563106796, 0, 0.0011124595469255664, 0.007281553398058253, 0.023058252427184466, 0, 0, 0, 0.13612459546925568, 0.0020226537216828477, 0, 0, 0, 0, 0.0024271844660194173, 0, 0, 0, 0.0057645631067961165, 0.028418284789644012, 0.008697411003236247, 0, 0, 0.0002022653721682848, 0.018507281553398057, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0014158576051779936, 0.0006067961165048543, 0.0001011326860841424, 0, 0, 0.0004045307443365696, 0.5570388349514563, 0.03337378640776699, 0, 0, 0, 0.004449838187702265, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0004045307443365696, 0, 0, 0.0001011326860841424, 112],

      [0.10766275778406793, 0.01101900525677315, 0.02426202992317024, 0, 0, 0.0022240194096239383, 0.018803073190456935, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.018095430651031138, 0, 0, 0, 0.08168216740800648, 0.02284674484431864, 0.011928831378892033, 0, 0, 0, 0.00303275374039628, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.05863323898099474, 0.010412454508693894, 0, 0, 0, 0.0017185604528912252, 0.5868378487666801, 0.028305701577031946, 0, 0, 0, 0.011120097048119693, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.000909826122118884, 0.00010109179134654265, 0, 0, 0.0004043671653861706, 108],

      [0.1442875738459998, 0.012015620306398318, 0.0065084609992990886, 0, 0.0030039050765995794, 0.016321217582857716, 0.010914188444978472, 0, 0, 0, 0.085711424852308, 0, 0, 0, 0, 0, 0.0032041654150395515, 0.00040052067687994393, 0, 0, 0.007109242014619005, 0.03484529888855512, 0.010914188444978472, 0, 0, 0, 0.02443176128967658, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0039050765995794533, 0.0031040352458195654, 0, 0, 0, 0.0014018223690798037, 0.6263142084710123, 0.005206768799439271, 0, 0, 0, 0.00020026033843997197, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00010013016921998598, 0.00010013016921998598, 0, 0, 0, 13],

      [0.18951895189518952, 0.0032003200320032004, 0, 0, 0.001000100010001, 0.004100410041004101, 0.0008000800080008001, 0, 0, 0, 0.0047004700470047005, 0, 0, 0, 0, 0, 0.0022002200220022, 0.00010001000100010001, 0, 0, 0.0022002200220022, 0.0744074407440744, 0.008200820082008202, 0, 0, 0, 0.005900590059005901, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.017901790179017902, 0.00020002000200020003, 0, 0, 0.0065006500650065, 0.6777677767776777, 0.0011001100110011, 0, 0, 0, 0.00020002000200020003, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],

      [0.16471530071049734, 0.0020014009806864803, 0, 0, 0.00010007004903432403, 0.0016011207845491844, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.1474031822275593, 0.0008005603922745922, 0, 0, 0.008105673971780246, 0.032622835985189634, 0.0023016111277894525, 0, 0, 0, 0.0020014009806864803, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.01220854598218753, 0.010407285099569698, 0.00020014009806864806, 0, 0, 0.0019013309316521566, 0.605924146902832, 0.003602521765235665, 0, 0, 0, 0.00020014009806864806, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0026018212748924246, 0.0013009106374462123, 0, 0, 0, 7],

      [0.1478147814781478, 0.0088008800880088, 0, 0, 0, 0.0046004600460046, 0.024302430243024302, 0, 0, 0, 0.013701370137013702, 0, 0, 0, 0, 0, 0.09920992099209922, 0.0005000500050005, 0, 0, 0.007300730073007301, 0.0314031403140314, 0.014001400140014001, 0, 0, 0, 0.008500850085008501, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.004100410041004101, 0.008600860086008601, 0.00010001000100010001, 0, 0, 0.0012001200120012002, 0.6176617661766176, 0.006800680068006801, 0, 0, 0, 0.00040004000400040005, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00040004000400040005, 0.0006000600060006001, 0, 0, 0, 1],

      [0.13994198259477844, 0.020206061818545562, 0.026607982394718416, 0, 0, 0.006401920576172852, 0.01870561168350505, 0, 0, 0, 0.036811043312993896, 0.00010003000900270081, 0, 0, 0, 0, 0.009702910873261979, 0.00020006001800540162, 0, 0, 0.032709812943883164, 0.029108732619785936, 0.012403721116334901, 0, 0, 0, 0.008002400720216065, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.033109932979893966, 0.006001800540162049, 0, 0, 0, 0.0007002100630189057, 0.6079823947184155, 0.010103030909272781, 0, 0, 0, 0.0005001500450135041, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0005001500450135041, 0.00020006001800540162, 0, 0, 0, 3],

      [0.19505851755526657, 0.018005401620486146, 0.005301590477143143, 0, 0.0005001500450135041, 0.012803841152345704, 0.015304591377413223, 0, 0, 0, 0.048214464339301794, 0, 0, 0, 0, 0, 0.010703210963288986, 0.00020006001800540162, 0, 0, 0.013404021206361909, 0.056316895068520556, 0.02230669200760228, 0, 0, 0, 0.016204861458437532, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0012003601080324098, 0.0031009302790837253, 0.0005001500450135041, 0, 0, 0.0006001800540162049, 0.5734720416124838, 0.006702010603180954, 0, 0, 0, 0.00010003000900270081, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],

      [0.15971597159715972, 0.004300430043004301, 0, 0, 0, 0.004800480048004801, 0.0009000900090009, 0, 0, 0, 0.005700570057005701, 0, 0, 0, 0, 0, 0.10171017101710171, 0.00020002000200020003, 0, 0, 0.0702070207020702, 0.054605460546054606, 0.010501050105010502, 0, 0, 0.00010001000100010001, 0.010301030103010301, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.014901490149014901, 0.0083008300830083, 0.00040004000400040005, 0, 0, 0.0028002800280028, 0.5476547654765477, 0.0023002300230023, 0, 0, 0, 0.00010001000100010001, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0005000500050005, 0, 0, 0, 0, 1],

      [0.2259, 0.0204, 0.0028, 0, 0.0016, 0.0177, 0.0338, 0, 0, 0, 0.0123, 0.0002, 0, 0, 0, 0, 0.001, 0.0006, 0, 0, 0.0006, 0.0583, 0.0326, 0, 0, 0.0021, 0.0149, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0004, 0.0034, 0.0022, 0, 0, 0.0003, 0.5609, 0.0074, 0, 0, 0, 0.0003, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0001, 0.0001, 0, 0, 0.0001, 0],

      [0.1605963578146888, 0.022113267960776464, 0.012207324394636782, 0, 0.0006003602161296778, 0.00840504302581549, 0.012607564538723234, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0012007204322593557, 0.0008004802881729037, 0.0008004802881729037, 0, 0.027416449869921953, 0.04852911747048229, 0.01650990594356614, 0, 0, 0.0020012007204322593, 0.02461476886131679, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0006003602161296778, 0.0013007804682809686, 0, 0, 0.00020012007204322593, 0.6492895737442466, 0.009505703422053232, 0, 0, 0, 0.00040024014408645187, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00010006003602161297, 0.00010006003602161297, 0, 0, 0.00010006003602161297, 6],

      [0.1640530759951749, 0.020004020908725374, 0.0015078407720144752, 0, 0.0005026135906714917, 0.015782066747084843, 0.021310816244471252, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00673502211499799, 0.0007036590269400884, 0.0002010454362685967, 0, 0.0011057498994772818, 0.04754724567752312, 0.00975070365902694, 0, 0, 0.0007036590269400884, 0.0065339766787293925, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0019099316445516687, 0.0012062726176115801, 0.00010052271813429835, 0, 0, 0.00010052271813429835, 0.6412344189786892, 0.05126658624849216, 0, 0, 0, 0.0075392038600723766, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0002010454362685967, 0, 0, 0, 0, 52],

      [0.16489893936361816, 0.013608164898939363, 0.017010206123674206, 0, 0.01110666399839904, 0.008004802881729037, 0.027716629977986792, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.012007204322593557, 0.04772863718230939, 0.018711226736041624, 0, 0, 0.005903542125275165, 0.010006003602161296, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.6464878927356413, 0.01580948569141485, 0, 0, 0, 0.0010006003602161296, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6],

      [0.13295260995892194, 0.02865444344254083, 0.01703236148682497, 0, 0.0015028554253080854, 0.016631600040076144, 0.01953712052900511, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0022041879571185253, 0, 0, 0.039174431419697425, 0.017733694018635407, 0, 0, 0.003907424105801022, 0.009618274721971746, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.6671676184751026, 0.03496643622883479, 0, 0, 0.00030057108506161706, 0.008616371105099689, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19],

      [0.17719491440584642, 0.023025327860646712, 0.00030033036339973974, 0, 0.002302532786064671, 0.016017619381319452, 0.07628391230353389, 0, 0, 0, 0.0010011012113324658, 0, 0, 0, 0, 0, 0.0032035238762638902, 0, 0, 0, 0.005405946541195315, 0.06627290019020923, 0.04224647111823005, 0, 0, 0.0010011012113324658, 0.008309140054059465, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00010011012113324657, 0.005205726298928822, 0.0019020923015316848, 0, 0, 0.0011012113324657122, 0.5491040144158574, 0.014716187806587245, 0, 0, 0, 0.005005506056662328, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00030033036339973974, 0, 0, 0, 0, 11],

      [0.134740422126638, 0.009002700810243073, 0.0008002400720216065, 0, 0.0014004201260378114, 0.00740222066619986, 0.00490147044113234, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0027008102430729217, 0.00010003000900270081, 0, 0, 0.009602880864259278, 0.06611983595078523, 0.02220666199859958, 0, 0, 0.00020006001800540162, 0.0069020706211863556, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.001100330099029709, 0.005901770531159348, 0.0018005401620486145, 0, 0, 0.00020006001800540162, 0.709812943883165, 0.014104231269380815, 0, 0, 0, 0.0010003000900270082, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],

      [0.15911591159115912, 0.018001800180018002, 0.0011001100110011, 0, 0.0008000800080008001, 0.012801280128012802, 0.04220422042204221, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0012001200120012002, 0, 0, 0, 0.016001600160016, 0.0408040804080408, 0.020602060206020602, 0, 0, 0.00010001000100010001, 0.004000400040004, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0006000600060006001, 0.0012001200120012002, 0, 0, 0, 0.00020002000200020003, 0.6775677567756776, 0.0036003600360036, 0, 0, 0, 0.00010001000100010001, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],

      [0.20374074814962992, 0.02380476095219044, 0.0018003600720144029, 0, 0.0035007001400280055, 0.010602120424084817, 0.009801960392078415, 0, 0, 0, 0.03340668133626725, 0, 0, 0, 0, 0, 0.010502100420084017, 0.0009001800360072014, 0.0007001400280056011, 0, 0.015103020604120825, 0.04930986197239448, 0.021704340868173636, 0, 0, 0.00040008001600320064, 0.03780756151230246, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.03790758151630326, 0.007601520304060812, 0, 0, 0, 0.00040008001600320064, 0.5166033206641328, 0.013402680536107221, 0, 0, 0, 0.0005001000200040008, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.00020004000800160032, 0.0003000600120024005, 0, 0, 0, 2],

      [0.15924331898708838, 0.013512160944850365, 0.012511260134120709, 0, 0.0060054048643779405, 0.009608647783004704, 0.000300270243218897, 0, 0, 0, 0.0016014412971674507, 0, 0, 0, 0, 0, 0.00530477429686718, 0.000300270243218897, 0.004904413972575318, 0, 0.007606846161545391, 0.041237113402061855, 0.0201181062956661, 0, 0, 0, 0.005805224702232009, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0028025222700430387, 0.004303873486137524, 0.0005004504053648283, 0, 0, 0.00010009008107296567, 0.693924532078871, 0.009808827945150636, 0, 0, 0, 0.0005004504053648283, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9]
      ];

    function normalizeHists() {
      for(var i = 0; i < 20; i++) {
        var sum = 0;
        for(var j = 0; j < 64 - 1; j++) {
          sum += normalizedhist[i][j];
        }
        for(var j = 0; j < 64 - 1; j++) {
          normalizedhist[i][j] /= sum;
        }
      } 
    }

    function getBin(r, g, b) {
      return (r >> 2) | (g >> 4) | (b >> 6);
    }

    function compare(a, b) {
      if (a[1] > b[1]) return 1;
      if (b[1] > a[1]) return -1;

      return 0;
    }

    function getClosestHist2(hist) {
      var result = [[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]];
      //result.index = -1;

      var isBlank = true;
      for(var i = 0; i < 63; i++) {
        if(hist[i] > 512) {
          isBlank = false;
          break;
        }
      }
      /*if(isBlank == true && hist[63] > 2000) {
        console.log("is blank!");
        return result;
      }*/

      var minDist = 999999999.9;
      for (var i = 0; i < 20; i++) {
        var d = getHistDist(hist, normalizedhist[i],64);
        result[i][0] = i;
        result[i][1] = d;
        console.log(i + " " + d);
        if (d < minDist) {
          minDist = d;
          result.index = i;
        }
      }

      return result.sort(compare);

      //if (result.index != -1) result.dist = minDist;
      //return result;
    }


    function getClosestHist(hist) {
      //console.log(".");
      var result = {index:-1, dist:9999999};
      //result.index = -1;

      var isBlank = true;
      for(var i = 0; i < 63; i++) {
        if(hist[i] > 512) {
          isBlank = false;
          break;
        }
      }
      /*if(isBlank == true && hist[63] > 2000) {
        console.log("is blank!");
        return result;
      }*/

      var minDist = 999999999.9;
      for (var i = 0; i < 20; i++) {
        var d = getHistDist(hist, basehist[i],64);
        console.log(i + " " + d);
        if (d < minDist) {
          minDist = d;
          result.index = i;
        }
      }
      if (result.index != -1) result.dist = minDist;
      return result;
    }
  
    function getMousePos(canvasDom, mouseEvent) {
      var rect = canvasDom.getBoundingClientRect();
      return {
        x: mouseEvent.clientX - rect.left,
        y: mouseEvent.clientY - rect.top
      };
    }

    function shoot() {
      var H = PerspT(srcCorners, dstCorners);
      var dstPt = H.transform(320, 240);      

      // envia o valor
      console.log("(" + ((dstPt[0]/720.0)-1) + "," + (1-dstPt[1]/1280) + ")");

      var s = "x=" + parseInt(dstPt[0]) + "&y=" + parseInt(dstPt[1]) + "&p=1";

      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "GET", "https://192.168.43.195:443/jsaruco/shoot.php?" + s, false); 
      //xmlHttp.open( "GET", "https://www.cin.ufpe.br/~jmxnt/shooter/shoot.php?" + s, false); // 
      // false for synchronous request
      xmlHttp.send( null );
      //return xmlHttp.responseText;

    }

    function onLoad(){
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      context = canvas.getContext("2d");

      context2 = document.getElementById("c2").getContext("2d");
      context2.fillStyle = "red";
      context2.fillRect(0, 0, 100, 100);

      var context3 = document.getElementById("trigger").getContext("2d");
      context3.fillStyle = "green";
      context3.fillRect(0, 0, 100, 100);

      document.getElementById("trigger").addEventListener('click', function() {
        //alert("teste");

        var content = "[";
        for(var i = 0; i < 63; i++) {
          content += tempHist[i] + ", ";
        }
        content += tempHist[i];
        content += "]<br><br><br>";

        document.getElementById("histotext").innerHTML += content;

      }, false);

      canvas.addEventListener("click", function (e) {
        //alert("PEI click!");
        shoot();
      }, false);

      /*canvas.addEventListener("touchstart", function (e) {
        alert("PEI touch!");
        shoot();
      }, false);*/
         
      canvas.width = parseInt(canvas.style.width);
      canvas.height = parseInt(canvas.style.height);

      // Cross browser
    navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    if (navigator.getUserMedia) {
      // Request access to video only
      navigator.getUserMedia(
        {
          video:{
          facingMode: 'environment'  
          },
          audio:false
        },    
        function(stream) {
          // Cross browser checks
          var url = window.URL || window.webkitURL;
              //v.src = url ? url.createObjectURL(stream) : stream;
        video.srcObject = stream; 
              // Set the video to play
              video.play();
        },
        function(error) {
          alert('Something went wrong. (error code ' + error.code + ')');
          return;
        }
      );
    }
    else {
      alert('Sorry, the browser you are using doesn\'t support getUserMedia');
      return;
    }

    detector = new AR.Detector();

        requestAnimationFrame(tick);
      
      /*navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (navigator.getUserMedia){
        
        function successCallback(stream){
          if (window.webkitURL) {
            //video.src = window.webkitURL.createObjectURL(stream);
            video.srcObject=stream;
            video.play();
          } else if (video.mozSrcObject !== undefined) {
            video.mozSrcObject = stream;
          } else {
            video.src = stream;
          }
        }
        
        function errorCallback(error){
        }
        
        navigator.getUserMedia({video: true}, successCallback, errorCallback);
        
        detector = new AR.Detector();

        requestAnimationFrame(tick);
      }*/

      //normalizeHists();

      console.log(normalizedhist);
    }
    
    function tick(){
      requestAnimationFrame(tick);
      
      if (video.readyState === video.HAVE_ENOUGH_DATA){
        snapshot();

        var markers = detector.detect(imageData);
        drawCorners(markers);
        drawId(markers);
      }
    }

    function highlightPiece(ht, n, color) {
      //[95, 62, 1271, 65, 1271, 1004, 92, 1005];

      var deltax = (puzzleCoords[2] - puzzleCoords[0])/5; 
      var deltay = (puzzleCoords[7] - puzzleCoords[1])/4;

      var x = n % 5;
      var y = Math.floor(n / 5);

      var pts = [0,0,0,0,0,0,0,0];
      pts[0] = puzzleCoords[0] + deltax * x;
      pts[1] = puzzleCoords[1] + deltay * y;
      pts[2] = pts[0] + deltax;
      pts[3] = pts[1];
      pts[4] = pts[2];
      pts[5] = pts[1] + deltay;
      pts[6] = pts[0];
      pts[7] = pts[5]; 

      for(var k = 0; k < 4; k++) {
        var pt = ht.transform(pts[k*2+0], pts[k*2+1]);
        //console.log(pt);
        pts[k*2+0] = pt[0];
        pts[k*2+1] = pt[1];

      }

      context.strokeStyle = color;
      context.beginPath();
              
      context.moveTo(pts[0], pts[1]);
      context.lineTo(pts[2], pts[3]);
      context.lineTo(pts[4], pts[5]);
      context.lineTo(pts[6], pts[7]);
      context.lineTo(pts[0], pts[1]);

      context.stroke();
      context.closePath();
    }

    function capturePiece() {
      
      //console.log("entrou no capture piece!");

      var piece100 = [0,0,99,0,99,99,0,99];

      var cidata = context.getImageData(0, 0, 640, 480);
      var c2idata = context2.getImageData(0, 0, 100, 100);

      var cdata = cidata.data;
      var c2data = c2idata.data;

      var H = PerspT(piece100, newPieceCoords);
      //console.log(H);

      for(var k = 0; k < 64; k++) {
        tempHist[k] = 0;
      }

      for( var i = 0; i < 100; i++) {
        for(var j = 0; j < 100; j++) {
          
          var dstPt = H.transform(j, i);

          dstPt[0] = Math.round(dstPt[0]);
          dstPt[1] = Math.round(dstPt[1]);

          c2data[(i*100 + j)*4 + 0] = cdata[(dstPt[1]*640 + dstPt[0])*4 + 0] & 0xC0;
          c2data[(i*100 + j)*4 + 1] = cdata[(dstPt[1]*640 + dstPt[0])*4 + 1] & 0xC0;
          c2data[(i*100 + j)*4 + 2] = cdata[(dstPt[1]*640 + dstPt[0])*4 + 2] & 0xC0;
          c2data[(i*100 + j)*4 + 3] = 255;//cdata[(dstPt[1]*640 + dstPt[0])*4 + 3];

          var bin = getBin(c2data[(i*100 + j)*4 + 2], c2data[(i*100 + j)*4 + 1], c2data[(i*100 + j)*4 + 0]);
          tempHist[bin] += 1;
        }
      }

      var sum = 0;
      for(var h = 0; h < 64 - 1; h++) {
        sum += tempHist[h];
      }
      for(var h = 0; h < 64 - 1; h++) {
        tempHist[h] /= sum;
      }

      //console.log(tempHist);

      //console.log(sampleHist);
      var piece = getClosestHist2(tempHist);
      //console.log(piece);

      highlightPiece(H2, piece[0][0], "#FF0000");
      highlightPiece(H2, piece[1][0], "#00FF00");
      highlightPiece(H2, piece[2][0], "#0000FF");

      /*if(piece.index != -1) {
        highlightPiece(H2, piece.index);
        console.log(piece);
      }*/

      //console.log(getHistDist(sampleHist, tempHist, 64));      

      context2.putImageData(c2idata, 0, 0);

    }

    function getHistDist(hist1, hist2, numBins) {
      var result = 0;
      for (var i = 0; i < numBins-1; i++) {
        result += (hist1[i] - hist2[i])*(hist1[i] - hist2[i]);
      }
      return result;
    }

    function snapshot(){
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    }
          
    function drawCorners(markers){
      var corners, corner, i, j;
    
      context.lineWidth = 3;

      // context.strokeStyle = "green";
      // context.beginPath();
      // context.moveTo(320, 240-5);
      // context.lineTo(320, 240+5);

      // context.moveTo(320-5, 240);
      // context.lineTo(320+5, 240);
      // context.stroke();
      // context.closePath();

      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        context.strokeStyle = "red";
        context.beginPath();
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          context.moveTo(corner.x, corner.y);
          corner = corners[(j + 1) % corners.length];
          context.lineTo(corner.x, corner.y);
          //console.log("(" + corner.x + "," + corner.y + ") ");
        }

        context.stroke();
        context.closePath();

        //console.log("\n");

        context.strokeStyle = "red";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);

        context.strokeStyle = "yellow";
        context.strokeRect(corners[1].x - 2, corners[1].y - 2, 4, 4);

        context.strokeStyle = "blue";
        context.strokeRect(corners[2].x - 2, corners[2].y - 2, 4, 4);

        context.strokeStyle = "green";
        context.strokeRect(corners[3].x - 2, corners[3].y - 2, 4, 4);

        srcCorners[0] = corners[0].x;
        srcCorners[1] = corners[0].y;
        srcCorners[2] = corners[1].x;
        srcCorners[3] = corners[1].y;
        srcCorners[4] = corners[2].x;
        srcCorners[5] = corners[2].y;
        srcCorners[6] = corners[3].x;
        srcCorners[7] = corners[3].y;

        H2 = PerspT(arucoCoords, srcCorners);
        //console.log(H);
        //console.log("(" + pieceCoords[0] + ","+ pieceCoords[1] + ")");

        //var dstPt = H.transform(pieceCoords[0], pieceCoords[1]);
        //console.log(dstPt);  

        for(var k = 0; k < 4; k++) {

          var pt = H2.transform(pieceCoords[k*2+0], pieceCoords[k*2+1]);
          //console.log(pt);
          newPieceCoords[k*2+0] = pt[0];
          newPieceCoords[k*2+1] = pt[1];

        }

        for(var k = 0; k < 4; k++) {

          var pt = H2.transform(puzzleCoords[k*2+0], puzzleCoords[k*2+1]);
          //console.log(pt);
          newPuzzleCoords[k*2+0] = pt[0];
          newPuzzleCoords[k*2+1] = pt[1];

        }

        context.strokeStyle = "red";
        context.beginPath();
                
        // context.moveTo(newPieceCoords[0], newPieceCoords[1]);
        // context.lineTo(newPieceCoords[2], newPieceCoords[3]);
        // context.lineTo(newPieceCoords[4], newPieceCoords[5]);
        // context.lineTo(newPieceCoords[6], newPieceCoords[7]);
        // context.lineTo(newPieceCoords[0], newPieceCoords[1]);

        context.strokeStyle = "blue";

        context.moveTo(newPuzzleCoords[0], newPuzzleCoords[1]);
        context.lineTo(newPuzzleCoords[2], newPuzzleCoords[3]);
        context.lineTo(newPuzzleCoords[4], newPuzzleCoords[5]);
        context.lineTo(newPuzzleCoords[6], newPuzzleCoords[7]);
        context.lineTo(newPuzzleCoords[0], newPuzzleCoords[1]);

        //console.log(newPieceCoords[0] + " " + newPieceCoords[1] + " " + newPieceCoords[2] + " " + newPieceCoords[3]); 

        context.stroke();
        context.closePath();

        capturePiece();


        // context.strokeStyle = "red";
        // context.beginPath();

        // context.moveTo(newPieceCoords[0], newPieceCoords[1]);
        // context.lineTo(newPieceCoords[2], newPieceCoords[3]);
        // context.lineTo(newPieceCoords[4], newPieceCoords[5]);
        // context.lineTo(newPieceCoords[6], newPieceCoords[7]);
        // context.lineTo(newPieceCoords[0], newPieceCoords[1]);

        // context.stroke();
        // context.closePath();

        //var H = PerspT(srcCorners, dstCorners);
        //var dstPt = H.transform(320, 240);

        //if(dstPt[0] < 0 || dstPt[0] > 1440 || dstPt[1] < 0 || dstPt[1] > 2560) {
        //  return;
        //}

        //console.log("(" + ((dstPt[0]/720.0)-1) + "," + (1-dstPt[1]/1280) + ")");

      }
    }

    function drawId(markers){
      var corners, corner, x, y, i, j;
      
      context.strokeStyle = "blue";
      context.lineWidth = 1;
      
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        x = Infinity;
        y = Infinity;
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          
          x = Math.min(x, corner.x);
          y = Math.min(y, corner.y);
        }

        context.strokeText(markers[i].id, x, y)
      }
    }

    window.onload = onLoad;
  </script>

</head>

<body style="font-family: monospace;">

  <center>
    <div style="margin: 10px;"><strong>-= Augmented Reality Marker Detector =-</strong></div>
    <video id="video" autoplay="true" style="display:none;"></video>
    <canvas id="canvas" style="width:640px; height:480px;"></canvas>
    <canvas id='trigger' width="100" height="100" bgcolor="green"></canvas>
    <canvas id='c2' width="100" height="100"></canvas>
    <br><br><br>
    <div id='histotext'></div>
    <div style="margin: 15px;"><strong>Powered by <a href="http://code.google.com/p/js-aruco/">js-aruco</a></strong></div>
  </center>

</body>
  
</html>