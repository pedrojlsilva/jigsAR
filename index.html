<html>

<head>
  <title>Augmented Reality Marker Detector</title>

  <script type="text/javascript" src="libs/polyfill.js"></script> 
  
  <script type="text/javascript" src="cv.js"></script> 
  <script type="text/javascript" src="aruco.js"></script> 
  <script type="text/javascript" src="perspective-transform.js"></script>

  <script>
    //oi
    var arucoCoords = [1308, 184, 1698, 182, 1701, 577, 1307, 575];
    var pieceCoords = [1307, 610, 1701, 610, 1701, 1004, 1304, 1004];
    var puzzleCoords = [95, 62, 1271, 65, 1271, 1004, 92, 1005];

    var newPieceCoords = [0, 0, 0, 0, 0, 0, 0, 0];
    var newPuzzleCoords = [0, 0, 0, 0, 0, 0, 0, 0];

    var srcCorners = [0, 1, 0, 0, 1, 0, 1, 1];
    var dstCorners = [564, 1468, 564, 1092, 939, 1092, 939, 1468];

    var video, canvas, context, context2, imageData, detector;

    var histograms = new Array(20 * 64); // using 64 bins per color histogram

    var H2;

    var tempHist = new Array(64);
    for(var i = 0; i < 64; i++) {
      tempHist[i] = i;
    }

    var sampleHist = [0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 35, 67, 243,
                      13, 212, 79, 132, 0, 0, 0, 0,
                      0, 0, 0, 0, 0, 0, 16, 201,
                      5, 261, 470, 472, 0, 296, 83, 109,
                      0, 0, 0, 0, 0, 0, 0, 0,
                      0, 0, 3, 30, 0, 0, 17, 7256];

    var basehist = [[857, 63, 24, 0, 0, 15, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 815, 37, 19, 0, 74, 245, 213, 58, 0, 0, 41, 103, 0, 0, 0, 64, 68, 0, 0, 0, 554, 47, 9, 1, 0, 29, 338, 35, 0, 0, 6, 57, 0, 0, 0, 0, 0, 0, 0, 0, 0, 125, 23, 0, 0, 0, 14, 6065],
    [1444, 44, 43, 0, 2, 52, 154, 0, 0, 1, 389, 754, 0, 0, 0, 0, 53, 0, 0, 0, 13, 210, 120, 0, 0, 25, 206, 276, 0, 0, 0, 0, 0, 0, 0, 0, 4, 12, 1, 0, 2, 87, 261, 45, 0, 0, 0, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 0, 0, 0, 2, 5754],
    [815, 76, 92, 0, 0, 12, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 71, 5, 75, 0, 133, 138, 147, 75, 0, 0, 12, 8, 0, 0, 0, 0, 0, 0, 0, 0, 355, 114, 1, 11, 107, 625, 247, 47, 0, 0, 0, 31, 0, 0, 0, 0, 0, 0, 0, 0, 0, 194, 17, 1, 0, 3, 12, 6573],
    [1268, 75, 1, 0, 138, 126, 20, 0, 0, 0, 26, 279, 0, 0, 0, 0, 18, 2, 0, 0, 46, 342, 95, 0, 0, 3, 161, 429, 0, 0, 0, 11, 0, 0, 0, 0, 21, 22, 4, 0, 14, 73, 437, 141, 0, 0, 2, 157, 0, 0, 0, 0, 0, 0, 0, 0, 0, 20, 11, 1, 0, 0, 8, 6049],
    [896, 19, 0, 0, 296, 13, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 69, 2, 0, 0, 466, 338, 26, 0, 1, 11, 46, 6, 0, 0, 0, 0, 0, 0, 0, 0, 14, 37, 0, 0, 0, 54, 805, 35, 0, 0, 1, 36, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 185, 2, 0, 0, 15, 6626]];

    var normalizedhist = [[0.15588045581595356, 0.012900451515803053, 0.0008600301010535369, 0, 0, 0.0017200602021070737, 0.0019350677273704579, 0, 0, 0, 0, 0.028380993334766718, 0, 0, 0, 0, 0.4035691249193722, 0.021070737475811653, 0.017415609546334122, 0, 0.004945173081057837, 0.029456030961083637, 0.052676843689529136, 0, 0, 0.0008600301010535369, 0.008600301010535369, 0.022360782627391957, 0, 0, 0, 0.0034401204042141475, 0.0025800903031606105, 0, 0, 0, 0.006880240808428295, 0.028380993334766718, 0.00043001505052676843, 0, 0, 0.03741130939582885, 0.059342076972694044, 0.004730165555794453, 0, 0, 0, 0.006880240808428295, 0, 0, 0, 0, 0, 0.0015050526768436896, 0, 0, 0.0027950978284239946, 0.038486347022145775, 0.027305955708449795, 0, 0, 0, 0.017200602021070738, 5349],
        [0.25011135857461025, 0.017817371937639197, 0.0011135857461024498, 0, 0, 0.014476614699331848, 0.00913140311804009, 0, 0, 0, 0.016035634743875277, 0.20289532293986637, 0, 0, 0, 0, 0.026503340757238307, 0.0022271714922048997, 0.0013363028953229399, 0, 0.0069042316258351895, 0.03763919821826281, 0.0465478841870824, 0.0006681514476614699, 0, 0.0006681514476614699, 0.043429844097995544, 0.11781737193763919, 0, 0, 0, 0.008463251670378619, 0.0008908685968819599, 0, 0, 0, 0.005345211581291759, 0.014253897550111359, 0.0006681514476614699, 0, 0.0015590200445434299, 0.02427616926503341, 0.058351893095768374, 0.014253897550111359, 0, 0, 0, 0.0060133630289532294, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.004454342984409799, 0.04365256124721604, 0.00044543429844097997, 0, 0, 0.022048997772828507, 5510],
        [0.12233169129720854, 0.017241379310344827, 0.0016420361247947454, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.04980842911877394, 0.0035577449370552817, 0.0035577449370552817, 0, 0.0150519978106185, 0.016967706622879036, 0.0873015873015873, 0.019157088122605363, 0, 0, 0.0005473453749315818, 0.012588943623426382, 0, 0, 0, 0, 0, 0, 0, 0, 0.07909140667761358, 0.025998905309250135, 0, 0.0002736726874657909, 0.060207991242474, 0.07006020799124248, 0.11603721948549535, 0.0049261083743842365, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.10454296661193213, 0.10125889436234264, 0.05309250136836344, 0.004378762999452655, 0, 0, 0.030377668308702793, 6346],
        [0.16463700234192039, 0.02271662763466042, 0, 0, 0.007494145199063232, 0.04379391100702576, 0.01756440281030445, 0, 0, 0, 0.023653395784543327, 0.14285714285714285, 0, 0, 0, 0.000702576112412178, 0.03442622950819672, 0.002576112412177986, 0.001873536299765808, 0, 0.04613583138173302, 0.054098360655737705, 0.034192037470725994, 0, 0, 0, 0.07072599531615925, 0.06510538641686182, 0, 0, 0, 0.001873536299765808, 0, 0, 0, 0, 0.01522248243559719, 0.01756440281030445, 0.000702576112412178, 0, 0.001405152224824356, 0.03185011709601874, 0.11358313817330211, 0.010304449648711944, 0, 0, 0, 0.011475409836065573, 0, 0, 0, 0, 0.000702576112412178, 0, 0, 0, 0.00819672131147541, 0.01826697892271663, 0.023653395784543327, 0, 0, 0, 0.012646370023419205, 5730],
        [0.21895074946466808, 0.0016059957173447537, 0, 0, 0.006423982869379015, 0.006959314775160599, 0.0010706638115631692, 0, 0, 0, 0.0010706638115631692, 0, 0, 0, 0, 0, 0.05353319057815846, 0, 0, 0, 0.2042291220556745, 0.0452355460385439, 0.0024089935760171306, 0, 0, 0, 0.013383297644539615, 0.014453961456102784, 0, 0, 0, 0.0024089935760171306, 0, 0, 0, 0, 0.007494646680942184, 0.04202355460385439, 0.0010706638115631692, 0, 0, 0.04362955032119915, 0.0974304068522484, 0.0016059957173447537, 0, 0, 0, 0.001873661670235546, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.04470021413276231, 0.16943254817987152, 0, 0, 0, 0.019004282655246254, 6264],
        [0.0629887054735013, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.23088618592528237, 0, 0, 0, 0.021720243266724587, 0.024543874891398785, 0, 0, 0, 0.00021720243266724586, 0, 0, 0, 0, 0, 0, 0.12076455256298871, 0, 0, 0, 0.250868809730669, 0.036055603822762815, 0, 0, 0.0017376194613379669, 0.020634231103388356, 0.04170286707211121, 0, 0, 0, 0.00021720243266724586, 0, 0.002172024326672459, 0, 0, 0, 0, 0.004995655951346655, 0, 0, 0.0008688097306689834, 0.059296264118158123, 0.07927888792354475, 0, 0, 0, 0.04105125977410947, 5396],
        [0.11073997944501542, 0.008478931140801645, 0, 0, 0, 0.007194244604316547, 0.0041109969167523125, 0, 0, 0, 0.004367934224049332, 0.0341726618705036, 0, 0, 0, 0, 0.13206577595066804, 0.00539568345323741, 0, 0, 0.018242548818088386, 0.04162384378211716, 0.012332990750256937, 0.0010277492291880781, 0, 0, 0.01618705035971223, 0.06423432682425488, 0, 0, 0, 0, 0.03391572456320658, 0, 0, 0, 0.25976361767728673, 0.024922918807810893, 0.0028263103802672147, 0, 0, 0.01618705035971223, 0.07965056526207605, 0.006423432682425488, 0, 0, 0, 0.009506680369989723, 0, 0, 0, 0, 0, 0.0007708119218910585, 0, 0, 0, 0.046248715313463515, 0.03905447070914697, 0.0010277492291880781, 0, 0, 0.019527235354573486, 6108],
        [0.1608187134502924, 0.020711500974658868, 0.0009746588693957114, 0, 0, 0.007309941520467836, 0.008528265107212475, 0, 0, 0, 0.0014619883040935672, 0.056530214424951264, 0, 0, 0, 0, 0.043859649122807015, 0.010964912280701754, 0.0021929824561403508, 0, 0.023391812865497075, 0.03313840155945419, 0.11232943469785575, 0.001705653021442495, 0, 0.0009746588693957114, 0.012914230019493177, 0.04434697855750487, 0, 0, 0, 0.0009746588693957114, 0, 0, 0, 0, 0.05579922027290448, 0.023148148148148147, 0.0014619883040935672, 0, 0.001949317738791423, 0.028996101364522416, 0.09283625730994152, 0.01145224171539961, 0, 0, 0, 0.008284600389863547, 0, 0, 0, 0, 0, 0, 0, 0, 0.02509746588693957, 0.11574074074074074, 0.06676413255360623, 0.003654970760233918, 0, 0, 0.02168615984405458, 5896],
        [0.3067524115755627, 0.015219721329046088, 0.00042872454448017146, 0, 0, 0.024866023579849947, 0.01007502679528403, 0, 0, 0, 0.012004287245444802, 0.04844587352625938, 0, 0, 0, 0.0015005359056806003, 0.04030010718113612, 0.002357984994640943, 0.0030010718113612006, 0, 0.023794212218649517, 0.07309753483386924, 0.04780278670953912, 0, 0, 0, 0.024008574490889605, 0.0660235798499464, 0, 0, 0, 0.009431939978563772, 0.0006430868167202572, 0, 0, 0, 0.01864951768488746, 0.024008574490889605, 0.0021436227224008574, 0, 0.009860664523043945, 0.02679528403001072, 0.11982851018220793, 0.0036441586280814577, 0, 0, 0, 0.008360128617363344, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.013504823151125401, 0.035584137191854236, 0.004287245444801715, 0, 0, 0.023579849946409433, 5335],
        [0.17777777777777778, 0.003003003003003003, 0, 0, 0, 0.00960960960960961, 0.0006006006006006006, 0, 0, 0, 0.0016016016016016017, 0.006206206206206206, 0, 0, 0, 0, 0.06246246246246246, 0, 0, 0, 0.026626626626626626, 0.05005005005005005, 0.0018018018018018018, 0, 0, 0, 0.014614614614614614, 0.012012012012012012, 0, 0, 0, 0, 0.01041041041041041, 0, 0, 0, 0.22162162162162163, 0.027427427427427428, 0.0002002002002002002, 0, 0.07807807807807808, 0.033433433433433433, 0.12692692692692692, 0.0016016016016016017, 0, 0, 0, 0, 0, 0, 0, 0, 0.0034034034034034033, 0.0032032032032032033, 0, 0, 0.043243243243243246, 0.02962962962962963, 0.03663663663663664, 0.0004004004004004004, 0, 0, 0.017417417417417418, 5005],
];

    function normalizeHists() {
      for(var i = 0; i < 10; i++) {
        var sum = 0;
        for(var j = 0; j < 64 - 1; j++) {
          sum += normalizedhist[i][j];
        }
        for(var j = 0; j < 64 - 1; j++) {
          normalizedhist[i][j] /= sum;
        }
      } 
    }

    function getBin(r, g, b) {
      return (r >> 2) | (g >> 4) | (b >> 6);
    }

    function compare(a, b) {
      if (a[1] > b[1]) return 1;
      if (b[1] > a[1]) return -1;

      return 0;
    }

    function getClosestHist2(hist) {
      var result = [[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]];
      //result.index = -1;

      var isBlank = true;
      for(var i = 0; i < 63; i++) {
        if(hist[i] > 512) {
          isBlank = false;
          break;
        }
      }
      /*if(isBlank == true && hist[63] > 2000) {
        console.log("is blank!");
        return result;
      }*/

      var minDist = 999999999.9;
      for (var i = 0; i < 10; i++) {
        var d = getHistDist(hist, normalizedhist[i],64);
        result[i][0] = i;
        result[i][1] = d;
        console.log(i + " " + d);
        if (d < minDist) {
          minDist = d;
          result.index = i;
        }
      }

      return result.sort(compare);

      //if (result.index != -1) result.dist = minDist;
      //return result;
    }


    function getClosestHist(hist) {
      //console.log(".");
      var result = {index:-1, dist:9999999};
      //result.index = -1;

      var isBlank = true;
      for(var i = 0; i < 63; i++) {
        if(hist[i] > 512) {
          isBlank = false;
          break;
        }
      }
      /*if(isBlank == true && hist[63] > 2000) {
        console.log("is blank!");
        return result;
      }*/

      var minDist = 999999999.9;
      for (var i = 0; i < 20; i++) {
        var d = getHistDist(hist, basehist[i],64);
        console.log(i + " " + d);
        if (d < minDist) {
          minDist = d;
          result.index = i;
        }
      }
      if (result.index != -1) result.dist = minDist;
      return result;
    }
  
    function getMousePos(canvasDom, mouseEvent) {
      var rect = canvasDom.getBoundingClientRect();
      return {
        x: mouseEvent.clientX - rect.left,
        y: mouseEvent.clientY - rect.top
      };
    }

    function shoot() {
      var H = PerspT(srcCorners, dstCorners);
      var dstPt = H.transform(320, 240);      

      // envia o valor
      console.log("(" + ((dstPt[0]/720.0)-1) + "," + (1-dstPt[1]/1280) + ")");

      var s = "x=" + parseInt(dstPt[0]) + "&y=" + parseInt(dstPt[1]) + "&p=1";

      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "GET", "https://192.168.43.195:443/jsaruco/shoot.php?" + s, false); 
      //xmlHttp.open( "GET", "https://www.cin.ufpe.br/~jmxnt/shooter/shoot.php?" + s, false); // 
      // false for synchronous request
      xmlHttp.send( null );
      //return xmlHttp.responseText;

    }

    function onLoad(){
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      context = canvas.getContext("2d");

      context2 = document.getElementById("c2").getContext("2d");
      context2.fillStyle = "red";
      context2.fillRect(0, 0, 100, 100);

      var context3 = document.getElementById("trigger").getContext("2d");
      context3.fillStyle = "green";
      context3.fillRect(0, 0, 100, 100);

      document.getElementById("trigger").addEventListener('click', function() {
        //alert("teste");

        var content = "[";
        for(var i = 0; i < 63; i++) {
          content += tempHist[i] + ", ";
        }
        content += tempHist[i];
        content += "]<br><br><br>";

        document.getElementById("histotext").innerHTML += content;

      }, false);

      canvas.addEventListener("click", function (e) {
        //alert("PEI click!");
        shoot();
      }, false);

      /*canvas.addEventListener("touchstart", function (e) {
        alert("PEI touch!");
        shoot();
      }, false);*/
         
      canvas.width = parseInt(canvas.style.width);
      canvas.height = parseInt(canvas.style.height);

      // Cross browser
    navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    if (navigator.getUserMedia) {
      // Request access to video only
      navigator.getUserMedia(
        {
          video:{
          facingMode: 'environment'  
          },
          audio:false
        },    
        function(stream) {
          // Cross browser checks
          var url = window.URL || window.webkitURL;
              //v.src = url ? url.createObjectURL(stream) : stream;
        video.srcObject = stream; 
              // Set the video to play
              video.play();
        },
        function(error) {
          alert('Something went wrong. (error code ' + error.code + ')');
          return;
        }
      );
    }
    else {
      alert('Sorry, the browser you are using doesn\'t support getUserMedia');
      return;
    }

    detector = new AR.Detector();

        requestAnimationFrame(tick);
      
      /*navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      if (navigator.getUserMedia){
        
        function successCallback(stream){
          if (window.webkitURL) {
            //video.src = window.webkitURL.createObjectURL(stream);
            video.srcObject=stream;
            video.play();
          } else if (video.mozSrcObject !== undefined) {
            video.mozSrcObject = stream;
          } else {
            video.src = stream;
          }
        }
        
        function errorCallback(error){
        }
        
        navigator.getUserMedia({video: true}, successCallback, errorCallback);
        
        detector = new AR.Detector();

        requestAnimationFrame(tick);
      }*/

      //normalizeHists();

      console.log(normalizedhist);
    }
    
    function tick(){
      requestAnimationFrame(tick);
      
      if (video.readyState === video.HAVE_ENOUGH_DATA){
        snapshot();

        var markers = detector.detect(imageData);
        drawCorners(markers);
        drawId(markers);
      }
    }

    function highlightPiece(ht, n, color) {
      //[95, 62, 1271, 65, 1271, 1004, 92, 1005];

      var deltax = (puzzleCoords[2] - puzzleCoords[0])/5; 
      var deltay = (puzzleCoords[7] - puzzleCoords[1])/4;

      var x = n % 5;
      var y = Math.floor(n / 5);

      var pts = [0,0,0,0,0,0,0,0];
      pts[0] = puzzleCoords[0] + deltax * x;
      pts[1] = puzzleCoords[1] + deltay * y;
      pts[2] = pts[0] + deltax;
      pts[3] = pts[1];
      pts[4] = pts[2];
      pts[5] = pts[1] + deltay;
      pts[6] = pts[0];
      pts[7] = pts[5]; 

      for(var k = 0; k < 4; k++) {
        var pt = ht.transform(pts[k*2+0], pts[k*2+1]);
        //console.log(pt);
        pts[k*2+0] = pt[0];
        pts[k*2+1] = pt[1];

      }

      context.strokeStyle = color;
      context.beginPath();
              
      context.moveTo(pts[0], pts[1]);
      context.lineTo(pts[2], pts[3]);
      context.lineTo(pts[4], pts[5]);
      context.lineTo(pts[6], pts[7]);
      context.lineTo(pts[0], pts[1]);

      context.stroke();
      context.closePath();
    }

    function capturePiece() {
      
      //console.log("entrou no capture piece!");

      var piece100 = [0,0,99,0,99,99,0,99];

      var cidata = context.getImageData(0, 0, 640, 480);
      var c2idata = context2.getImageData(0, 0, 100, 100);

      var cdata = cidata.data;
      var c2data = c2idata.data;

      var H = PerspT(piece100, newPieceCoords);
      //console.log(H);

      for(var k = 0; k < 64; k++) {
        tempHist[k] = 0;
      }

      for( var i = 0; i < 100; i++) {
        for(var j = 0; j < 100; j++) {
          
          var dstPt = H.transform(j, i);

          dstPt[0] = Math.round(dstPt[0]);
          dstPt[1] = Math.round(dstPt[1]);

          c2data[(i*100 + j)*4 + 0] = cdata[(dstPt[1]*640 + dstPt[0])*4 + 0] & 0xC0;
          c2data[(i*100 + j)*4 + 1] = cdata[(dstPt[1]*640 + dstPt[0])*4 + 1] & 0xC0;
          c2data[(i*100 + j)*4 + 2] = cdata[(dstPt[1]*640 + dstPt[0])*4 + 2] & 0xC0;
          c2data[(i*100 + j)*4 + 3] = 255;//cdata[(dstPt[1]*640 + dstPt[0])*4 + 3];

          var bin = getBin(c2data[(i*100 + j)*4 + 2], c2data[(i*100 + j)*4 + 1], c2data[(i*100 + j)*4 + 0]);
          tempHist[bin] += 1;
        }
      }

      var sum = 0;
      for(var h = 0; h < 64 - 1; h++) {
        sum += tempHist[h];
      }
      for(var h = 0; h < 64 - 1; h++) {
        tempHist[h] /= sum;
      }

      //console.log(tempHist);

      //console.log(sampleHist);
      var piece = getClosestHist2(tempHist);
      //console.log(piece);

      highlightPiece(H2, piece[0][0], "#FF0000");
      highlightPiece(H2, piece[1][0], "#00FF00");
      highlightPiece(H2, piece[2][0], "#0000FF");

      /*if(piece.index != -1) {
        highlightPiece(H2, piece.index);
        console.log(piece);
      }*/

      //console.log(getHistDist(sampleHist, tempHist, 64));      

      context2.putImageData(c2idata, 0, 0);

    }

    function getHistDist(hist1, hist2, numBins) {
      var result = 0;
      for (var i = 0; i < numBins-1; i++) {
        result += (hist1[i] - hist2[i])*(hist1[i] - hist2[i]);
      }
      return result;
    }

    function snapshot(){
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    }
          
    function drawCorners(markers){
      var corners, corner, i, j;
    
      context.lineWidth = 3;

      // context.strokeStyle = "green";
      // context.beginPath();
      // context.moveTo(320, 240-5);
      // context.lineTo(320, 240+5);

      // context.moveTo(320-5, 240);
      // context.lineTo(320+5, 240);
      // context.stroke();
      // context.closePath();

      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        context.strokeStyle = "red";
        context.beginPath();
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          context.moveTo(corner.x, corner.y);
          corner = corners[(j + 1) % corners.length];
          context.lineTo(corner.x, corner.y);
          //console.log("(" + corner.x + "," + corner.y + ") ");
        }

        context.stroke();
        context.closePath();

        //console.log("\n");

        context.strokeStyle = "red";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);

        context.strokeStyle = "yellow";
        context.strokeRect(corners[1].x - 2, corners[1].y - 2, 4, 4);

        context.strokeStyle = "blue";
        context.strokeRect(corners[2].x - 2, corners[2].y - 2, 4, 4);

        context.strokeStyle = "green";
        context.strokeRect(corners[3].x - 2, corners[3].y - 2, 4, 4);

        srcCorners[0] = corners[0].x;
        srcCorners[1] = corners[0].y;
        srcCorners[2] = corners[1].x;
        srcCorners[3] = corners[1].y;
        srcCorners[4] = corners[2].x;
        srcCorners[5] = corners[2].y;
        srcCorners[6] = corners[3].x;
        srcCorners[7] = corners[3].y;

        H2 = PerspT(arucoCoords, srcCorners);
        //console.log(H);
        //console.log("(" + pieceCoords[0] + ","+ pieceCoords[1] + ")");

        //var dstPt = H.transform(pieceCoords[0], pieceCoords[1]);
        //console.log(dstPt);  

        for(var k = 0; k < 4; k++) {

          var pt = H2.transform(pieceCoords[k*2+0], pieceCoords[k*2+1]);
          //console.log(pt);
          newPieceCoords[k*2+0] = pt[0];
          newPieceCoords[k*2+1] = pt[1];

        }

        for(var k = 0; k < 4; k++) {

          var pt = H2.transform(puzzleCoords[k*2+0], puzzleCoords[k*2+1]);
          //console.log(pt);
          newPuzzleCoords[k*2+0] = pt[0];
          newPuzzleCoords[k*2+1] = pt[1];

        }

        context.strokeStyle = "red";
        context.beginPath();
                
        // context.moveTo(newPieceCoords[0], newPieceCoords[1]);
        // context.lineTo(newPieceCoords[2], newPieceCoords[3]);
        // context.lineTo(newPieceCoords[4], newPieceCoords[5]);
        // context.lineTo(newPieceCoords[6], newPieceCoords[7]);
        // context.lineTo(newPieceCoords[0], newPieceCoords[1]);

        context.strokeStyle = "blue";

        context.moveTo(newPuzzleCoords[0], newPuzzleCoords[1]);
        context.lineTo(newPuzzleCoords[2], newPuzzleCoords[3]);
        context.lineTo(newPuzzleCoords[4], newPuzzleCoords[5]);
        context.lineTo(newPuzzleCoords[6], newPuzzleCoords[7]);
        context.lineTo(newPuzzleCoords[0], newPuzzleCoords[1]);

        //console.log(newPieceCoords[0] + " " + newPieceCoords[1] + " " + newPieceCoords[2] + " " + newPieceCoords[3]); 

        context.stroke();
        context.closePath();

        capturePiece();


        // context.strokeStyle = "red";
        // context.beginPath();

        // context.moveTo(newPieceCoords[0], newPieceCoords[1]);
        // context.lineTo(newPieceCoords[2], newPieceCoords[3]);
        // context.lineTo(newPieceCoords[4], newPieceCoords[5]);
        // context.lineTo(newPieceCoords[6], newPieceCoords[7]);
        // context.lineTo(newPieceCoords[0], newPieceCoords[1]);

        // context.stroke();
        // context.closePath();

        //var H = PerspT(srcCorners, dstCorners);
        //var dstPt = H.transform(320, 240);

        //if(dstPt[0] < 0 || dstPt[0] > 1440 || dstPt[1] < 0 || dstPt[1] > 2560) {
        //  return;
        //}

        //console.log("(" + ((dstPt[0]/720.0)-1) + "," + (1-dstPt[1]/1280) + ")");

      }
    }

    function drawId(markers){
      var corners, corner, x, y, i, j;
      
      context.strokeStyle = "blue";
      context.lineWidth = 1;
      
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        x = Infinity;
        y = Infinity;
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          
          x = Math.min(x, corner.x);
          y = Math.min(y, corner.y);
        }

        context.strokeText(markers[i].id, x, y)
      }
    }

    window.onload = onLoad;
  </script>

</head>

<body style="font-family: monospace;">

  <center>
    <div style="margin: 10px;"><strong>-= Augmented Reality Marker Detector =-</strong></div>
    <video id="video" autoplay="true" style="display:none;"></video>
    <canvas id="canvas" style="width:640px; height:480px;"></canvas>
    <canvas id='trigger' width="100" height="100" bgcolor="green"></canvas>
    <canvas id='c2' width="100" height="100"></canvas>
    <br><br><br>
    <div id='histotext'></div>
    <div style="margin: 15px;"><strong>Powered by <a href="http://code.google.com/p/js-aruco/">js-aruco</a></strong></div>
  </center>

</body>
  
</html>